import { z } from 'zod';
import { idSchema, paginationSchema, sortOrderSchema } from './base';

// ==============================
// ðŸŽ“ API æ¨¡å¼ (ä»ŽåŽŸ common åŒ…è¿ç§»)
// ==============================

// è¯¾ç¨‹ç›¸å…³æžšä¸¾æ¨¡å¼
export const courseStatusSchema = z.enum(['Draft', 'Published'], {
  errorMap: () => ({ message: 'è¯¾ç¨‹çŠ¶æ€å¿…é¡»æ˜¯ Draft æˆ– Published' }),
});

export const courseLevelSchema = z.enum(
  ['Beginner', 'Intermediate', 'Advanced'],
  {
    errorMap: () => ({
      message:
        'è¯¾ç¨‹ç­‰çº§å¿…é¡»æ˜¯ Beginnerã€Intermediateã€Advanced ä¸­çš„ä¸€ä¸ª',
    }),
  }
);

export const chapterTypeSchema = z.enum(['Text', 'Video', 'Quiz'], {
  errorMap: () => ({
    message: 'ç« èŠ‚ç±»åž‹å¿…é¡»æ˜¯ Textã€Videoã€Quiz ä¸­çš„ä¸€ä¸ª',
  }),
});

// è¯¾ç¨‹åˆ›å»ºæ¨¡å¼
export const createCourseSchema = z
  .object({
    teacherId: idSchema,
    teacherName: z
      .string()
      .min(1, 'æ•™å¸ˆåç§°ä¸ºå¿…å¡«é¡¹')
      .max(100, 'æ•™å¸ˆåç§°ä¸èƒ½è¶…è¿‡100å­—'),
    title: z
      .string()
      .min(1, 'è¯¾ç¨‹æ ‡é¢˜ä¸ºå¿…å¡«é¡¹')
      .max(200, 'è¯¾ç¨‹æ ‡é¢˜ä¸èƒ½è¶…è¿‡200å­—'),
    description: z
      .string()
      .min(10, 'è¯¾ç¨‹æè¿°è‡³å°‘éœ€è¦10ä¸ªå­—')
      .max(2000, 'è¯¾ç¨‹æè¿°ä¸èƒ½è¶…è¿‡2000å­—')
      .optional(),
    category: z
      .string()
      .min(1, 'åˆ†ç±»ä¸ºå¿…å¡«é¡¹')
      .max(50, 'åˆ†ç±»ä¸èƒ½è¶…è¿‡50å­—'),
    price: z
      .number()
      .min(0, 'ä»·æ ¼å¿…é¡»å¤§äºŽç­‰äºŽ0')
      .max(50000000, 'ä»·æ ¼ä¸èƒ½è¶…è¿‡5åƒä¸‡')
      .optional(), // å¢žåŠ åˆ°5åƒä¸‡
    level: courseLevelSchema,
    status: courseStatusSchema.default('Draft'),
    image: z.string().url('è¯·è¾“å…¥æ­£ç¡®çš„å›¾ç‰‡URLæ ¼å¼').optional(),
  })
  .strict();

// è¯¾ç¨‹æ›´æ–°æ¨¡å¼
export const updateCourseSchema = z
  .object({
    title: z
      .string()
      .min(1, 'è¯¾ç¨‹æ ‡é¢˜ä¸ºå¿…å¡«é¡¹')
      .max(200, 'è¯¾ç¨‹æ ‡é¢˜ä¸èƒ½è¶…è¿‡200å­—')
      .optional(),
    description: z
      .string()
      .min(10, 'è¯¾ç¨‹æè¿°è‡³å°‘éœ€è¦10ä¸ªå­—')
      .max(2000, 'è¯¾ç¨‹æè¿°ä¸èƒ½è¶…è¿‡2000å­—')
      .optional(),
    category: z
      .string()
      .min(1, 'åˆ†ç±»ä¸ºå¿…å¡«é¡¹')
      .max(50, 'åˆ†ç±»ä¸èƒ½è¶…è¿‡50å­—')
      .optional(),
    price: z
      .number()
      .min(0, 'ä»·æ ¼å¿…é¡»å¤§äºŽç­‰äºŽ0')
      .max(50000000, 'ä»·æ ¼ä¸èƒ½è¶…è¿‡5åƒä¸‡')
      .optional(), // å¢žåŠ åˆ°5åƒä¸‡
    level: courseLevelSchema.optional(),
    status: courseStatusSchema.optional(),
    image: z.string().url('è¯·è¾“å…¥æ­£ç¡®çš„å›¾ç‰‡URLæ ¼å¼').optional(),
  })
  .strict();

// è¯¾ç¨‹æœç´¢æŸ¥è¯¢æ¨¡å¼ (ä¿®æ”¹ç‰ˆ)
export const courseQuerySchema = paginationSchema
  .extend({
    category: z.string().optional(),
    level: courseLevelSchema.optional(),
    status: courseStatusSchema.optional(),
    search: z
      .string()
      .max(100, 'æœç´¢å…³é”®è¯ä¸èƒ½è¶…è¿‡100å­—')
      .optional(),
    teacherId: idSchema.optional(),
    minPrice: z
      .string()
      .optional()
      .transform((val) => {
        if (!val || val === '') return undefined;
        const num = parseFloat(val);
        if (isNaN(num) || num < 0) return undefined;
        return num;
      }),
    maxPrice: z
      .string()
      .optional()
      .transform((val) => {
        if (!val || val === '') return undefined;
        const num = parseFloat(val);
        if (isNaN(num) || num < 0) return undefined;
        return num;
      }),
    sortBy: z
      .enum(['createdAt', 'updatedAt', 'title', 'price'])
      .default('createdAt'),
    sortOrder: sortOrderSchema,
  })
  .strict();

// æ”¯ä»˜ç›¸å…³æ¨¡å¼
export const paymentProviderSchema = z.enum(['stripe', 'paypal', 'kakao_pay'], {
  errorMap: () => ({
    message: 'æ”¯ä»˜æä¾›å•†å¿…é¡»æ˜¯ stripeã€paypalã€kakao_pay ä¸­çš„ä¸€ä¸ª',
  }),
});

// Stripeæ”¯ä»˜æ„å‘åˆ›å»ºæ¨¡å¼
export const createStripePaymentIntentSchema = z
  .object({
    amount: z
      .number()
      .min(0, 'æ”¯ä»˜é‡‘é¢å¿…é¡»å¤§äºŽç­‰äºŽ0')
      .max(
        99999999,
        'æ”¯ä»˜é‡‘é¢ä¸èƒ½è¶…è¿‡9,999ä¸‡å…ƒ (StripeéŸ©å…ƒé™åˆ¶)'
      ), // ç¬¦åˆStripeéŸ©å…ƒé™åˆ¶
    courseId: idSchema, // æ·»åŠ ä¸ºå¿…å¡«å­—æ®µ
    currency: z.string().default('krw'),
    metadata: z.record(z.string()).optional(),
  })
  .strict();

// äº¤æ˜“æŸ¥è¯¢æ¨¡å¼
export const transactionQuerySchema = paginationSchema
  .extend({
    userId: idSchema.optional(),
    courseId: idSchema.optional(),
    paymentProvider: paymentProviderSchema.optional(),
    startDate: z.string().datetime().optional(),
    endDate: z.string().datetime().optional(),
    minAmount: z
      .string()
      .optional()
      .transform((val) => {
        if (!val || val === '') return undefined;
        const num = parseFloat(val);
        if (isNaN(num) || num < 0) return undefined;
        return num;
      }),
    maxAmount: z
      .string()
      .optional()
      .transform((val) => {
        if (!val || val === '') return undefined;
        const num = parseFloat(val);
        if (isNaN(num) || num < 0) return undefined;
        return num;
      }),
    sortBy: z.enum(['createdAt', 'updatedAt', 'amount']).default('createdAt'),
    sortOrder: sortOrderSchema,
  })
  .strict();

export const createTransactionSchema = z
  .object({
    userId: idSchema,
    courseId: idSchema,
    transactionId: z
      .string()
      .min(1, 'äº¤æ˜“IDä¸ºå¿…å¡«é¡¹')
      .max(100, 'äº¤æ˜“IDä¸èƒ½è¶…è¿‡100å­—'),
    amount: z
      .number()
      .min(0, 'é‡‘é¢å¿…é¡»å¤§äºŽç­‰äºŽ0')
      .max(50000000, 'é‡‘é¢ä¸èƒ½è¶…è¿‡5åƒä¸‡'), // å¢žåŠ åˆ°5åƒä¸‡
    paymentProvider: paymentProviderSchema,
  })
  .strict();

// å­¦ä¹ è¿›åº¦ç›¸å…³æ¨¡å¼
export const chapterProgressSchema = z
  .object({
    chapterId: idSchema,
    completed: z.boolean(),
    completedAt: z.string().datetime().optional(),
    timeSpent: z.number().min(0, 'å­¦ä¹ æ—¶é—´å¿…é¡»å¤§äºŽç­‰äºŽ0').optional(), // å•ä½ï¼šç§’
  })
  .strict();

export const sectionProgressSchema = z
  .object({
    sectionId: idSchema,
    chapters: z.array(chapterProgressSchema),
  })
  .strict();

export const updateUserCourseProgressSchema = z
  .object({
    sections: z.array(sectionProgressSchema).optional(),
    overallProgress: z
      .number()
      .min(0, 'æ€»è¿›åº¦å¿…é¡»å¤§äºŽç­‰äºŽ0')
      .max(100, 'æ€»è¿›åº¦ä¸èƒ½è¶…è¿‡100')
      .optional(),
    lastAccessedChapterId: idSchema.optional(),
  })
  .strict();

// TypeScript ç±»åž‹å¯¼å‡º
export type CreateCourseDto = z.infer<typeof createCourseSchema>;
export type UpdateCourseDto = z.infer<typeof updateCourseSchema>;
export type CourseQueryDto = z.infer<typeof courseQuerySchema>;
export type CreateStripePaymentIntentDto = z.infer<
  typeof createStripePaymentIntentSchema
>;
export type TransactionQueryDto = z.infer<typeof transactionQuerySchema>;
export type CreateTransactionDto = z.infer<typeof createTransactionSchema>;
export type ChapterProgressDto = z.infer<typeof chapterProgressSchema>;
export type SectionProgressDto = z.infer<typeof sectionProgressSchema>;
export type UpdateUserCourseProgressDto = z.infer<
  typeof updateUserCourseProgressSchema
>;

// å·¥å…·å‡½æ•°
export function validateCoursePrice(price: number): boolean {
  return price >= 0 && price <= 50000000; // å¢žåŠ åˆ°5åƒä¸‡
}

export function calculateCourseProgress(
  sections: SectionProgressDto[]
): number {
  if (!sections.length) return 0;

  const totalChapters = sections.reduce(
    (sum, section) => sum + section.chapters.length,
    0
  );
  const completedChapters = sections.reduce(
    (sum, section) =>
      sum + section.chapters.filter((chapter) => chapter.completed).length,
    0
  );

  return totalChapters > 0
    ? Math.round((completedChapters / totalChapters) * 100)
    : 0;
}

export function sanitizeCourseQuery(query: any): CourseQueryDto {
  const result = courseQuerySchema.safeParse(query);
  if (!result.success) {
    throw new Error(
      `æ— æ•ˆçš„è¯¾ç¨‹æŸ¥è¯¢: ${result.error.errors.map((e) => e.message).join(', ')}`
    );
  }
  return result.data;
}
